<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRL Team ‚Ä¢ –ò–¥–µ–∏</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg: #09090b;
            --bg2: #000000;
            --text: #f4f4f5;
            --hint: #a1a1aa;
            --accent: #d4d4d8;
            --accent-bright: #ffffff;
            --accent-light: rgba(255, 255, 255, 0.08);
            --metal: linear-gradient(145deg, #18181b 0%, #0f0f11 50%, #09090b 100%);
            --metal-border: 1px solid rgba(255, 255, 255, 0.08);
            --metal-shine: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, transparent 50%);
            --card-bg: #0f0f11;
            --green: #34d399;
            --orange: #fb923c;
            --red: #ef4444;
            --purple: #a78bfa;
            --radius: 16px;
            --radius-sm: 12px;
            --shadow: 0 8px 32px rgba(0,0,0,0.6);
            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', -apple-system, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-body); background: var(--bg2); color: var(--text); min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; }

        .header {
            background: rgba(15, 15, 17, 0.8);
            backdrop-filter: blur(10px);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            border-bottom: var(--metal-border);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .header-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            color: var(--accent-bright);
            font-weight: 700;
            font-family: var(--font-display);
        }
        .header-info { flex: 1; min-width: 0; }
        .header-title { font-family: var(--font-display); font-size: 16px; font-weight: 700; letter-spacing: -0.01em; }
        .header-sub { font-size: 12px; color: var(--hint); margin-top: 2px; text-transform: uppercase; font-weight: 500; letter-spacing: 0.05em; }

        .stats-card {
            background: var(--metal);
            margin: 16px;
            border-radius: var(--radius);
            padding: 24px 20px;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05);
        }
        .stats-card .stats-card-value { font-family: var(--font-display); font-size: 34px; font-weight: 700; letter-spacing: -0.03em; color: var(--accent-bright); text-shadow: 0 0 24px rgba(255,255,255,0.15); }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            margin: 0 16px 16px;
            padding: 16px;
            box-shadow: var(--shadow);
            position: relative;
            border: var(--metal-border);
        }
        .card::before { content: ''; position: absolute; inset: 0; background: var(--metal-shine); pointer-events: none; border-radius: inherit; }

        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex; align-items: flex-end; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal {
            background: var(--bg);
            border-radius: 20px 20px 0 0;
            width: 100%; max-width: 600px; max-height: 90vh;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            border: var(--metal-border); border-bottom: none;
            box-shadow: 0 -8px 40px rgba(0,0,0,0.8);
        }
        .modal.show { transform: translateY(0); }
        .modal-header {
            padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: var(--metal-border);
            flex-shrink: 0;
        }
        .modal-drag-indicator {
            width: 36px; height: 4px;
            background: var(--hint); opacity: 0.4;
            border-radius: 2px;
            position: absolute; top: 8px; left: 50%;
            transform: translateX(-50%);
        }
        .modal-body { padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        .category-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px; -ms-overflow-style: none; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .category-pill {
            padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: var(--metal-border); background: var(--card-bg);
            color: var(--hint); white-space: nowrap; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; font-family: var(--font-body);
        }
        .category-pill.selected {
            background: rgba(255,255,255,0.1);
            color: var(--accent-bright);
            border-color: rgba(255,255,255,0.2);
        }

        .form-group { margin-bottom: 20px; }
        .form-label { font-size: 11px; font-weight: 600; color: var(--hint); margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.05em; }

        .input, .select, .textarea {
            width: 100%; padding: 14px; border-radius: 12px;
            border: var(--metal-border); background: var(--card-bg);
            color: var(--text); font-size: 15px; font-family: inherit;
            transition: 0.2s; appearance: none;
        }
        .input:focus, .select:focus, .textarea:focus {
            border-color: rgba(255,255,255,0.3);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.05);
        }
        .textarea { resize: none; min-height: 100px; }

        .poll-container { margin-top: 16px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: var(--radius-sm); border: var(--metal-border); }
        .poll-question { font-weight: 600; margin-bottom: 16px; font-size: 15px; color: var(--text); }
        .poll-option {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; margin-bottom: 8px;
            background: var(--card-bg); border: var(--metal-border);
            border-radius: 10px; cursor: pointer; transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .poll-option:hover { border-color: rgba(255,255,255,0.2); }
        .poll-option.voted { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.04); }
        .poll-option-text { flex: 1; font-weight: 500; color: var(--text); font-size: 14px; }
        .poll-option-votes { font-size: 13px; font-weight: 600; color: var(--hint); margin-left: 12px; }
        .poll-option.voted .poll-option-votes { color: var(--accent-bright); }
        .poll-progress { position: absolute; left: 0; top: 0; height: 100%; background: rgba(255,255,255,0.08); transition: width 0.3s ease; z-index: 1; }
        .poll-option-content { position: relative; z-index: 2; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .poll-total { text-align: center; margin-top: 12px; font-size: 12px; color: var(--hint); }

        /* Poll Options */
        .poll-option-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            border: var(--metal-border);
            background: rgba(255,255,255,0.02);
            cursor: pointer;
            flex-shrink: 0;
            transition: 0.2s;
        }
        .btn-remove { color: var(--red); }
        .btn-remove:active { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); }
        
        .btn-add { width: 100%; padding: 12px; background: rgba(255,255,255,0.02); color: var(--accent-bright); font-weight: 600; border-radius: 12px; border: 1px dashed rgba(255,255,255,0.2); margin-top: 8px; transition: 0.2s; font-size: 14px; }
        .btn-add:active { background: rgba(255,255,255,0.05); }
        
        .btn-primary {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
            color: var(--accent-bright);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            font-weight: 600; font-size: 15px; font-family: var(--font-body);
            cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-primary:active { transform: scale(0.98); background: rgba(255,255,255,0.15); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .fab {
            position: fixed; bottom: 24px; right: 24px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--metal); color: var(--accent-bright);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 24px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 40; transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <div class="header-avatar">
            <img v-if="user?.photo_url" :src="user.photo_url" style="width:100%;height:100%;object-fit:cover;">
            <span v-else>{{ user?.first_name?.[0] || '?' }}</span>
        </div>
        <div class="header-info">
            <div class="header-title">IRL Team ‚Ä¢ –ò–¥–µ–∏</div>
            <div class="header-sub">{{ ideas.length }} –∑–∞–ø–∏—Å–µ–π</div>
        </div>
    </div>

    <div class="stats-card">
        <div style="font-size: 11px; color: var(--hint); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">–í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</div>
        <div class="stats-card-value">{{ totalVotes }}</div>
        <div style="display:flex; gap:24px; margin-top:16px; border-top: var(--metal-border); padding-top:16px;">
            <div>
                <div style="font-family: var(--font-display); font-weight:700; font-size:20px; color: var(--text);">{{ ideas.length }}</div>
                <div style="font-size:11px; color: var(--hint); text-transform: uppercase; font-weight: 500;">–ò–¥–µ–π</div>
            </div>
            <div>
                <div style="font-family: var(--font-display); font-weight:700; font-size:20px; color: var(--text);">{{ topIdeasCount }}</div>
                <div style="font-size:11px; color: var(--hint); text-transform: uppercase; font-weight: 500;">–í —Ç–æ–ø–µ</div>
            </div>
        </div>
    </div>

    <div style="padding-bottom: 100px;">
        <div v-if="loading" style="text-align: center; padding: 40px; color: var(--hint); font-size: 14px; font-weight: 500;">
            –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
        </div>

        <div v-else-if="ideas.length === 0" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 40px; margin-bottom: 12px; opacity: 0.5;">üí°</div>
            <h3 style="font-weight: 600;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
            <p style="color: var(--hint); margin-top: 8px; font-size: 14px;">–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –∏–¥–µ—é!</p>
        </div>

        <div v-for="idea in sortedIdeas" :key="idea.id" class="card">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                <div style="display:flex; gap:12px; align-items:center;">
                    <div style="width:36px; height:36px; background:rgba(255,255,255,0.03); border: var(--metal-border); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:14px; font-family: var(--font-display); font-weight:700; color: var(--hint);">
                        {{ idea.user_name?.[0] || '?' }}
                    </div>
                    <div>
                        <div style="font-weight:600; font-size:14px; color: var(--text);">{{ idea.user_name }}</div>
                        <div style="font-size:12px; color:var(--hint); margin-top: 2px;">{{ formatDate(idea.created_at) }}</div>
                    </div>
                </div>
                <div style="padding:6px 10px; background:rgba(255,255,255,0.03); border: var(--metal-border); border-radius:8px; font-size:11px; font-weight:600; display:flex; align-items:center; gap:6px; color: var(--hint);">
                    {{ getCategoryIcon(idea.category) }} {{ idea.category }}
                </div>
            </div>

            <div v-if="isPoll(idea)" class="poll-container">
                <div class="poll-question">{{ getPollData(idea).question }}</div>
                <div v-for="(option, idx) in getPollData(idea).options" :key="idx" 
                     class="poll-option"
                     :class="{ voted: hasVotedInPoll(idea, idx) }"
                     @click="voteInPoll(idea, idx)">
                    <div class="poll-progress" 
                         :style="{ width: (getPollData(idea).votes[idx] / Math.max(1, getPollData(idea).votes.reduce((a,b) => a+b, 0)) * 100) + '%' }">
                    </div>
                    <div class="poll-option-content">
                        <div class="poll-option-text">{{ option }}</div>
                        <div class="poll-option-votes">{{ getPollData(idea).votes[idx] }}</div>
                    </div>
                </div>
                <div class="poll-total">
                    –í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤: {{ getPollData(idea).votes.reduce((a,b) => a+b, 0) }}
                </div>
            </div>

            <div v-else style="white-space: pre-wrap; font-size: 14px; line-height: 1.6; color: var(--text);">{{ idea.content }}</div>

            <div style="margin-top: 16px; display: flex; align-items: center; justify-content: space-between; border-top: var(--metal-border); padding-top: 12px;">
                <button @click="vote(idea)" 
                        style="background:rgba(255,255,255,0.03); border: var(--metal-border); border-radius: 8px; padding: 6px 12px; display:flex; align-items:center; gap:8px; font-weight:600; font-size:13px; cursor:pointer; transition: 0.2s;"
                        :style="{ color: hasLiked(idea) ? 'var(--red)' : 'var(--hint)', borderColor: hasLiked(idea) ? 'rgba(239,68,68,0.3)' : '' }">
                    <svg width="16" height="16" viewBox="0 0 24 24" :fill="hasLiked(idea) ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    {{ idea.votes_count }}
                </button>
            </div>
        </div>
    </div>

    <button class="fab" @click="openModal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
    </button>

    <div class="modal-overlay" :class="{ show: showModal }" @click="closeModal">
        <div class="modal" :class="{ show: showModal }" @click.stop>
            <div class="modal-drag-indicator"></div>
            
            <div class="modal-header">
                <div style="font-family: var(--font-display); font-weight: 700; font-size: 16px; letter-spacing: -0.01em;">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</div>
                <button @click="closeModal" style="background: rgba(255,255,255,0.05); border: var(--metal-border); width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; color: var(--text); cursor:pointer;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –∑–∞–ø–∏—Å–∏</label>
                    <div class="category-scroll">
                        <div v-for="cat in categories" 
                             :key="cat.id" 
                             class="category-pill"
                             :class="{ selected: form.category === cat.id }"
                             @click="setCategory(cat.id)">
                            <span style="opacity: 0.8;">{{ cat.icon }}</span>
                            {{ cat.name }}
                        </div>
                    </div>
                </div>

                <div class="form-group" v-if="['bug', 'mentor'].includes(form.category)">
                    <label class="form-label">–°–µ—Ä–≤–∏—Å <span style="color:var(--red)">*</span></label>
                    <select v-model="form.service" class="select">
                        <option value="" disabled>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å...</option>
                        <option v-for="svc in serviceList" :key="svc" :value="svc">{{ svc }}</option>
                    </select>
                </div>

                <div class="form-group" v-if="form.category === 'improvement'">
                    <label class="form-label">–ß—Ç–æ —É–ª—É—á—à–∏—Ç—å <span style="color:var(--red)">*</span></label>
                    <input v-model="form.target" type="text" class="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–∏–∑–∞–π–Ω –ø—Ä–æ—Ñ–∏–ª—è">
                </div>

                <div class="form-group" v-if="form.category === 'mentor'">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ <span style="color:var(--red)">*</span></label>
                    <input v-model="form.title" type="text" class="input" placeholder="–ö—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º—ã">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        {{ form.category === 'poll' ? '–í–æ–ø—Ä–æ—Å –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è' : 
                           form.category === 'bug' ? '–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã' : 
                           form.category === 'mentor' ? '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞' : '–û–ø–∏—Å–∞–Ω–∏–µ' }}
                           <span style="color:var(--red)">*</span>
                    </label>
                    <textarea 
                        v-model="form.content" 
                        class="textarea" 
                        :placeholder="getPlaceholder"
                        rows="4"
                    ></textarea>
                </div>

                <div class="form-group" v-if="form.category === 'poll'">
                    <label class="form-label">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ ({{ form.options.length }}/6)</label>
                    
                    <div v-for="(opt, idx) in form.options" :key="idx" class="poll-option-row">
                        <div style="font-weight:600; color:var(--hint); width: 24px; font-size: 13px;">{{ idx + 1 }}.</div>
                        <input v-model="form.options[idx]" type="text" class="input" :placeholder="'–í–∞—Ä–∏–∞–Ω—Ç ' + (idx+1)">
                        <button v-if="form.options.length > 2" @click="removeOption(idx)" class="btn-icon btn-remove">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        </button>
                    </div>

                    <button v-if="form.options.length < 6" @click="addOption" class="btn-add">
                        + –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç
                    </button>
                </div>

                <div style="margin-top: 32px;">
                    <button class="btn-primary" @click="submitIdea" :disabled="!canSubmit || isSubmitting">
                        <span v-if="isSubmitting">–û—Ç–ø—Ä–∞–≤–∫–∞...</span>
                        <span v-else>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp, ref, computed, onMounted, reactive } = Vue
const { createClient } = supabase

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase
const SUPABASE_URL = 'https://sqoehqvvrbbgaqvkniyw.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxb2VocXZ2cmJiZ2FxdmtuaXl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODkzODUsImV4cCI6MjA4MjU2NTM4NX0.-Qam5GFLwzFCvM2MrEYv3HbLeRYUPOLPnLRqcLPcasg'
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

createApp({
    setup() {
        // –î–∞–Ω–Ω—ã–µ
        const user = ref(null)
        const ideas = ref([])
        const serviceList = ref([])
        const loading = ref(true)
        const showModal = ref(false)
        const isSubmitting = ref(false)

        // –§–æ—Ä–º–∞
        const form = reactive({
            category: 'idea',
            content: '',
            service: '',
            target: '',
            title: '',
            options: ['', '']
        })

        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categories = [
            { id: 'idea', name: '–ò–¥–µ—è', icon: 'üí°' },
            { id: 'poll', name: '–û–ø—Ä–æ—Å', icon: 'üìä' },
            { id: 'bug', name: '–ë–∞–≥', icon: 'üêõ' },
            { id: 'improvement', name: '–£–ª—É—á—à–µ–Ω–∏–µ', icon: '‚ö°' },
            { id: 'mentor', name: '–ù–∞—Å—Ç–∞–≤–Ω–∏–∫', icon: 'üë®‚Äçüè´' },
            { id: 'service', name: '–°–µ—Ä–≤–∏—Å', icon: 'üõ†Ô∏è' }
        ]

        const tg = window.Telegram.WebApp

        // Computed
        const totalVotes = computed(() => ideas.value.reduce((acc, i) => acc + (i.votes_count || 0), 0))
        const topIdeasCount = computed(() => ideas.value.filter(i => (i.votes_count || 0) >= 5).length)
        
        const sortedIdeas = computed(() => {
            return [...ideas.value].sort((a, b) => {
                if (b.votes_count !== a.votes_count) return b.votes_count - a.votes_count
                return new Date(b.created_at) - new Date(a.created_at)
            })
        })

        const getPlaceholder = computed(() => {
            const map = {
                poll: '–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∫–æ–º–∞–Ω–¥–µ...',
                bug: '–û–ø–∏—à–∏—Ç–µ –æ—à–∏–±–∫—É, —à–∞–≥–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è...',
                improvement: '–ö–∞–∫ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–µ–∫—Ç—É?',
                mentor: '–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, —Å—Å—ã–ª–∫–∏, –º–∞—Ç–µ—Ä–∏–∞–ª—ã...',
                service: '–û–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞...',
                idea: '–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∏–¥–µ—é –ø–æ–¥—Ä–æ–±–Ω–æ...'
            }
            return map[form.category] || '–¢–µ–∫—Å—Ç...'
        })

        const canSubmit = computed(() => {
            if (!form.content.trim()) return false
            
            if (form.category === 'poll') {
                return form.options.filter(o => o.trim()).length >= 2
            }
            if (form.category === 'bug') return !!form.service
            if (form.category === 'mentor') return !!form.service && !!form.title.trim()
            if (form.category === 'improvement') return !!form.target.trim()
            
            return true
        })

        // Methods
        const openModal = () => { showModal.value = true; tg.HapticFeedback.impactOccurred('light'); }
        
        const closeModal = () => {
            showModal.value = false
            setTimeout(() => {
                form.category = 'idea'
                form.content = ''
                form.service = ''
                form.target = ''
                form.title = ''
                form.options = ['', '']
            }, 300)
        }

        const setCategory = (id) => {
            form.category = id
            tg.HapticFeedback.selectionChanged()
        }

        const addOption = () => { if (form.options.length < 6) form.options.push('') }
        const removeOption = (idx) => { if (form.options.length > 2) form.options.splice(idx, 1) }

        const hasLiked = (idea) => idea.liked_by?.includes(user.value?.id?.toString())

        const isPoll = (idea) => {
            try {
                const parsed = JSON.parse(idea.content)
                return parsed.question && parsed.options && Array.isArray(parsed.options)
            } catch {
                return false
            }
        }

        const getPollData = (idea) => {
            try {
                return JSON.parse(idea.content)
            } catch {
                return null
            }
        }

        const hasVotedInPoll = (idea, optionIndex) => {
            const pollData = getPollData(idea)
            if (!pollData || !pollData.voters) return false
            return pollData.voters[optionIndex]?.includes(user.value?.id?.toString())
        }

        const voteInPoll = async (idea, optionIndex) => {
            const pollData = getPollData(idea)
            if (!pollData) return

            const userId = user.value.id.toString()
            const hasVoted = hasVotedInPoll(idea, optionIndex)

            const votedOptionIndex = pollData.voters.findIndex(voters => voters.includes(userId))
            
            if (votedOptionIndex !== -1 && votedOptionIndex !== optionIndex) {
                pollData.votes[votedOptionIndex]--
                pollData.voters[votedOptionIndex] = pollData.voters[votedOptionIndex].filter(id => id !== userId)
            }

            if (hasVoted) {
                pollData.votes[optionIndex]--
                pollData.voters[optionIndex] = pollData.voters[optionIndex].filter(id => id !== userId)
            } else {
                pollData.votes[optionIndex]++
                if (!pollData.voters[optionIndex]) pollData.voters[optionIndex] = []
                pollData.voters[optionIndex].push(userId)
            }

            const { error } = await sb.from('ideas')
                .update({ content: JSON.stringify(pollData) })
                .eq('id', idea.id)

            if (!error) {
                const idx = ideas.value.findIndex(i => i.id === idea.id)
                if (idx !== -1) {
                    ideas.value[idx].content = JSON.stringify(pollData)
                }
                tg.HapticFeedback.selectionChanged()
            }
        }

        const formatDate = (dateStr) => {
            const d = new Date(dateStr)
            return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })
        }

        const getCategoryIcon = (catName) => {
            const cat = categories.find(c => c.name === catName)
            return cat ? cat.icon : 'üìù'
        }

        // --- Data Logic ---

        const fetchData = async () => {
            loading.value = true
            const { data: ideasData } = await sb.from('ideas').select('*').order('created_at', { ascending: false })
            if (ideasData) ideas.value = ideasData

            const { data: mentorsData } = await sb.from('mentors').select('service_name').eq('is_active', true)
            if (mentorsData) {
                serviceList.value = [...new Set(mentorsData.map(m => m.service_name))]
            }
            loading.value = false
        }

        const vote = async (idea) => {
            tg.HapticFeedback.selectionChanged()
            const isLiked = hasLiked(idea)
            const userId = user.value.id.toString()
            
            if (isLiked) {
                idea.votes_count--
                idea.liked_by = idea.liked_by.filter(id => id !== userId)
            } else {
                idea.votes_count++
                if (!idea.liked_by) idea.liked_by = []
                idea.liked_by.push(userId)
            }

            const { error } = await sb.rpc('toggle_vote', {
                row_id: idea.id,
                user_tg_id: userId
            })
            if (error) console.error(error)
        }

        const submitIdea = async () => {
            if (!canSubmit.value) return
            isSubmitting.value = true
            tg.HapticFeedback.notificationOccurred('success')

            let finalContent = form.content.trim()

            if (form.category === 'bug') {
                finalContent = `üêõ –°–µ—Ä–≤–∏—Å: ${form.service}\n\n${finalContent}`
            } else if (form.category === 'improvement') {
                finalContent = `‚ö° –£–ª—É—á—à–∏—Ç—å: ${form.target}\n\n${finalContent}`
            } else if (form.category === 'mentor') {
                finalContent = `üë®‚Äçüè´ –°–µ—Ä–≤–∏—Å: ${form.service}\nüìå –¢–µ–º–∞: ${form.title}\n\n${finalContent}`
            } else if (form.category === 'poll') {
                const validOptions = form.options.filter(o => o.trim())
                const pollData = {
                    question: finalContent,
                    options: validOptions,
                    votes: validOptions.map(() => 0),
                    voters: validOptions.map(() => [])
                }
                finalContent = JSON.stringify(pollData)
            }

            const catObj = categories.find(c => c.id === form.category)
            
            const newIdea = {
                user_id: user.value.id.toString(),
                user_name: user.value.username ? `@${user.value.username}` : user.value.first_name,
                content: finalContent,
                category: catObj ? catObj.name : '–ò–¥–µ—è',
                votes_count: 0,
                liked_by: []
            }

            const { data, error } = await sb.from('ideas').insert(newIdea).select()

            if (!error && data) {
                ideas.value.unshift(data[0])
                closeModal()
            } else {
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏')
            }
            isSubmitting.value = false
        }

        onMounted(() => {
            tg.ready()
            tg.expand()
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ —à–∞–ø–∫–∏ Telegram –ø–æ–¥ –Ω–æ–≤—É—é –≥–∞–º–º—É
            tg.setHeaderColor('#09090b')
            tg.setBackgroundColor('#000000')

            if (tg.initDataUnsafe?.user) {
                user.value = tg.initDataUnsafe.user
            } else {
                user.value = { id: 123456, first_name: 'Test', username: 'tester', photo_url: '' }
            }

            fetchData()

            sb.channel('public:ideas')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'ideas' }, (payload) => {
                    if (payload.eventType === 'INSERT') ideas.value.unshift(payload.new)
                    if (payload.eventType === 'UPDATE') {
                        const idx = ideas.value.findIndex(i => i.id === payload.new.id)
                        if (idx !== -1) ideas.value[idx] = payload.new
                    }
                    if (payload.eventType === 'DELETE') {
                        ideas.value = ideas.value.filter(i => i.id !== payload.old.id)
                    }
                })
                .subscribe()
        })

        return {
            user, ideas, sortedIdeas, loading, form, categories, serviceList,
            showModal, isSubmitting, totalVotes, topIdeasCount, canSubmit, getPlaceholder,
            openModal, closeModal, setCategory, addOption, removeOption,
            vote, hasLiked, submitIdea, formatDate, getCategoryIcon,
            isPoll, getPollData, hasVotedInPoll, voteInPoll
        }
    }
}).mount('#app')
</script>
</body>
</html>
